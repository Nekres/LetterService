<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://fonts.googleapis.com/css?family=Indie+Flower" rel="stylesheet">
        <script src="js/CookieUtils.js"></script>
        <script src="js/apiFunctions.js"></script>
        <link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.3/jquery.min.js"></script>
        <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
        <script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
        <link rel="stylesheet" type="text/css" href="css/styles.css">
        <title>Letter Service</title>
    </head>
    <body>
        <div data-role="page" id="page">
            <div data-role="header" data-position="fixed">
                <a href="#userlist" class="ui-btn ui-btn-b ui-corner-all ui-shadow ui-icon-home ui-btn-icon-left">Contacts</a>
                <h1>Letter Service</h1>
                <a href="#" onclick="logout()" class="ui-btn ui-btn-b ui-corner-all ui-shadow ui-icon-back ui-btn-icon-left">Logout</a>

            </div>
            <div data-role="main" class="ui-content" id="general_page">
                
            </div>
            <div data-role="panel" id="userlist" >
                <h2 id="greeting">Привет, </h2>
                <div id="avatar"> </div>
            </div>
    <div data-role="footer" id="footer" data-position="fixed">
        <p>Сообщение:</p>
        <textarea name="addinfo" id="mbody" ></textarea>
        <a href="#" class="ui-btn" onclick="sendMsg()">Отправить</a>
        <input type="hidden" name = "receiver_id" value="1" id="receiver_id">
</div>
    </div>
            <!--            <div id="messages" class="cmessages" ></div> -->

        <!--                    <form action="msg.send" method="POST" id="message_form" >
                                <textarea  rows="3" name="m_body" id="message_body_field"></textarea>
                                <input type="hidden" name="receiver_id" value="" id="receiver_id" />
                                <input type="submit" value="Send" name="send" />
                            </form>
        
        -->                
        <script type="text/javascript" language="javascript">
            unathorizedCheck();
            var delete_cookie = function (name) {
                document.cookie = name + '=;expires=Thu, 01 Jan 1970 00:00:01 GMT;';
            };
            function sendMsg(){
                var receiver_id = $("#receiver_id").val();
                var body = $("#mbody").val();
                //clear field
                $("#mbody").val('');
                alert(body);
                $.ajax({
                    type:"POST",
                    url:"msg.send",
                    data:"m_body=" + body + "&receiver_id=" + receiver_id,
                    success: function (data, textStatus, jqXHR) {
                        alert("Message send!")
                    }
                });
            }
            function logout(){
                $.ajax({
                    type:"POST",
                    url:"logout",
                    success: function (data, textStatus, jqXHR) {
                            window.location.href = jqXHR.getResponseHeader("Location");
                    }
                });
            }
            $(document).ready(function () {
                var name = getCookie("user_name");
                var photo_url = getCookie("user_photo");
                $("#avatar").append("<img src=" + photo_url + " id=\"avatar_img\">");
                $("#greeting").append(name);
                $("#message_form").submit(function (e)
                {
                    e.preventDefault();
                    $.ajax({
                        type: 'post',
                        contentType: "application/x-www-form-urlencoded ; charset=UTF-8",
                        url: 'msg.send',
                        data: encodeURI($('#message_form').serialize()),
                        cache: false,
                        success:
                                function (url) {
                                    alert("Message successfully send.");
                                }
                    });
                    return false;
                });
                    $.getJSON("users.all?", function (user) {
                        for (let i = 0; i < user.length; i++) {
                            var input = document.createElement("a");
                            var linkText = document.createTextNode(user[i].name);
                            input.appendChild(linkText);
                            input.href = "#";
                            input.title = user[i].id;
                            input.onclick = function(){openDialogBox(user[i].id);};
                            input.setAttribute("class", "ui-btn ui-btn-b ui-corner-all ui-shadow ui-icon-arrow-r ui-btn-icon-left");
                            input.setAttribute("data-transition", "slide");
                            $("#userlist").append(input);
                        }
                    });
            });
        </script>
        <!--
             
-->     <script type="text/javascript" language="javascript">
         $(document).ready(function () {
             $.getJSON("msg.get?msgcount=5&receiver_id=1", function (message) {
                 var msg = message;
                 for (var j = 0; j < msg.length; j++) {
                     for (var g = 0; g < msg.length - 1; g++) {
                         if (msg[g].id > msg[g + 1].id) {
                             var temp = msg[g];
                             msg[g] = msg[g + 1];
                             msg[g + 1] = temp;
                         }
                     }
                 }
                 
                 $("#receiver_id").val(1);
                 var date = new Date(msg[0].date);
                 $("#general_page").append("<p>" + date.getHours() + ':' + date.getMinutes() + "<br>" + decodeURIComponent(msg[0].body) + "</p>");
                    for (var c = 1; c < msg.length; c++) {
                     var ids = msg[c].id;
                     console.log(ids);
                     var date = new Date(msg[c].date);
                     $("#general_page").append("<p>" + date.getHours() + ':' + date.getMinutes() + "<br>" + decodeURIComponent(msg[c].body) + "</p>");
                     $("#general_page").height(500);

                 }
                 
             });
         })
     </script><!--
        -->            <script type="text/javascript" language="javascript">
            $(document).ready(function () {
                
            });
            function openDialogBox(recipient_id) {
                $("#general_page").empty();
                $("#receiver_id").val(recipient_id);
                var messagesBox = document.getElementById("general_page").value;
                alert('msgload');
                $.getJSON("msg.get?msgcount=5&receiver_id=" + recipient_id, function (msg) {
                    for (var j = 0; j < msg.length; j++)
                        for (var i = 0; i < msg.length - 1; i++) {
                            if (msg[i].id > msg[i + 1].id) {
                                var temp = msg[i];
                                msg[i] = msg[i + 1];
                                msg[i + 1] = temp;
                            }
                        }
                    
                    var date = new Date(msg[0].date);
                    $("#general_page").html("<p>" + date.getHours() + ':' + date.getMinutes() + "<br>" + decodeURIComponent(msg[0].body) + "</p>");

                    for (var g = 1; g < msg.length; g++) {
                        console.log(msg[g].id);
                        var date = new Date(msg[g].date);

                        var str = "<p>" + date.getHours() + ':' + date.getMinutes() + "<br>" + decodeURIComponent(msg[g].body) + "</p>";
                        $("#general_page").append(str);
                        console.log(str);
                    }
                });
            }
        </script>
    </body>
</html>
